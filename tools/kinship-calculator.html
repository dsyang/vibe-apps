<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A calculator-style app for determining the correct Chinese kinship terms for extended family members using traditional characters and Taiwanese conventions." />
    <title>è¦ªå±¬ç¨±è¬‚è¨ˆç®—æ©Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --ink: #1a1410;
            --cream: #f5f0e8;
            --red: #c23a2e;
            --red-dark: #9e2e24;
            --gold: #c9a84c;
            --gold-light: #e8d9a0;
            --jade: #4a7c6f;
            --jade-dark: #3a6359;
            --warm-gray: #8c8278;
            --paper: #ede7db;
            --shadow: rgba(26, 20, 16, 0.12);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--cream);
            color: var(--ink);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(201, 168, 76, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(194, 58, 46, 0.04) 0%, transparent 50%);
        }

        .calculator {
            width: 100%;
            max-width: 420px;
            background: var(--paper);
            border-radius: 20px;
            box-shadow:
                0 2px 4px var(--shadow),
                0 8px 24px var(--shadow),
                0 24px 48px rgba(26, 20, 16, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            overflow: hidden;
            border: 1px solid rgba(26, 20, 16, 0.06);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
            padding: 20px 24px 16px;
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 18px,
                rgba(255,255,255,0.03) 18px,
                rgba(255,255,255,0.03) 19px
            );
        }

        .header h1 {
            font-family: 'Noto Serif TC', serif;
            font-weight: 900;
            font-size: 22px;
            color: #fff;
            letter-spacing: 4px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-top: 4px;
            font-weight: 300;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        /* Display */
        .display-area {
            padding: 20px 24px;
            background: linear-gradient(180deg, rgba(26,20,16,0.02) 0%, transparent 100%);
            border-bottom: 1px solid rgba(26,20,16,0.06);
        }

        .expression {
            font-family: 'Noto Serif TC', serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--ink);
            min-height: 42px;
            display: flex;
            align-items: center;
            letter-spacing: 1px;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
        }

        .expression::-webkit-scrollbar { display: none; }

        .expression .placeholder {
            color: var(--warm-gray);
            font-weight: 400;
        }

        .expression .de {
            color: var(--gold);
            margin: 0 1px;
        }

        .result-area {
            min-height: 48px;
            display: flex;
            align-items: center;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px dashed rgba(26,20,16,0.1);
        }

        .result-area .label {
            font-size: 13px;
            color: var(--warm-gray);
            font-weight: 300;
        }

        .result-area .result {
            font-family: 'Noto Serif TC', serif;
            font-size: 32px;
            font-weight: 900;
            color: var(--red);
            letter-spacing: 2px;
            animation: resultPop 0.3s ease-out;
        }

        .result-area .result-note {
            font-size: 12px;
            color: var(--warm-gray);
            margin-top: 4px;
            font-weight: 300;
        }

        .result-area .result-pinyin {
            font-size: 15px;
            color: var(--jade);
            margin-top: 2px;
            font-weight: 400;
            letter-spacing: 1px;
            font-style: italic;
        }

        @keyframes resultPop {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .result-area .error {
            font-size: 14px;
            color: var(--warm-gray);
            font-style: italic;
        }

        /* Button Grid */
        .buttons {
            padding: 16px 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-row {
            display: grid;
            gap: 10px;
        }

        .btn-row.family { grid-template-columns: repeat(4, 1fr); }
        .btn-row.controls { grid-template-columns: repeat(4, 1fr); }

        .section-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--warm-gray);
            padding: 4px 8px 2px;
            font-weight: 500;
        }

        button {
            font-family: 'Noto Sans TC', sans-serif;
            border: none;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-family {
            background: #fff;
            color: var(--ink);
            font-size: 18px;
            padding: 14px 4px;
            box-shadow: 0 1px 3px var(--shadow), 0 1px 0 rgba(255,255,255,0.8) inset;
            border: 1px solid rgba(26,20,16,0.06);
            letter-spacing: 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1px;
            line-height: 1.1;
        }

        .btn-family .en {
            font-size: 8px;
            letter-spacing: 0.5px;
            color: var(--warm-gray);
            font-weight: 400;
        }

        .btn-family:hover {
            background: #fefcf8;
            box-shadow: 0 2px 8px var(--shadow);
            transform: translateY(-1px);
        }

        .btn-family:active {
            transform: translateY(0) scale(0.97);
            box-shadow: 0 1px 2px var(--shadow);
            background: var(--gold-light);
        }

        .btn-de {
            background: linear-gradient(135deg, var(--gold) 0%, #d4b255 100%);
            color: #fff;
            font-size: 20px;
            padding: 14px 4px;
            font-weight: 700;
            letter-spacing: 2px;
            box-shadow: 0 2px 6px rgba(201, 168, 76, 0.3);
        }

        .btn-de:hover {
            box-shadow: 0 4px 12px rgba(201, 168, 76, 0.4);
            transform: translateY(-1px);
        }

        .btn-equals {
            background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
            color: #fff;
            font-size: 20px;
            padding: 14px 4px;
            font-weight: 700;
            letter-spacing: 2px;
            box-shadow: 0 2px 6px rgba(194, 58, 46, 0.3);
        }

        .btn-equals:hover {
            box-shadow: 0 4px 12px rgba(194, 58, 46, 0.4);
            transform: translateY(-1px);
        }

        .btn-clear {
            background: var(--jade);
            color: #fff;
            font-size: 13px;
            padding: 14px 4px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .btn-clear:hover {
            background: var(--jade-dark);
        }

        .btn-back {
            background: var(--warm-gray);
            color: #fff;
            font-size: 16px;
            padding: 14px 4px;
            font-weight: 500;
        }

        .btn-back:hover {
            background: #7a736a;
        }

        /* Spouse / In-law toggle */
        .toggle-row {
            display: flex;
            gap: 8px;
            padding: 0 4px;
        }

        .btn-toggle {
            flex: 1;
            background: transparent;
            color: var(--warm-gray);
            font-size: 11px;
            padding: 8px 4px;
            border: 1px solid rgba(26,20,16,0.1);
            border-radius: 8px;
            letter-spacing: 1px;
        }

        .btn-toggle.active {
            background: var(--ink);
            color: var(--cream);
            border-color: var(--ink);
        }

        .btn-toggle:hover:not(.active) {
            border-color: var(--ink);
            color: var(--ink);
        }

        /* Sound toggle */
        .sound-toggle {
            position: absolute;
            top: 18px;
            right: 20px;
            z-index: 2;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: #fff;
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .sound-toggle:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }

        .sound-toggle:active {
            transform: scale(0.95);
        }

        .sound-toggle.off {
            opacity: 0.5;
        }

        .sound-toggle .icon-on,
        .sound-toggle .icon-off {
            position: absolute;
            transition: opacity 0.2s ease;
        }

        .sound-toggle.off .icon-on { opacity: 0; }
        .sound-toggle.off .icon-off { opacity: 1; }
        .sound-toggle:not(.off) .icon-on { opacity: 1; }
        .sound-toggle:not(.off) .icon-off { opacity: 0; }

        /* Speaking indicator pulse */
        .speaking-indicator {
            display: none;
            width: 8px;
            height: 8px;
            background: var(--gold);
            border-radius: 50%;
            position: absolute;
            top: -2px;
            right: -2px;
            animation: speakPulse 0.8s ease-in-out infinite;
        }

        .speaking-indicator.active {
            display: block;
        }

        @keyframes speakPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.6; }
        }

        /* Footer */
        .footer {
            padding: 12px 24px 16px;
            text-align: center;
            font-size: 10px;
            color: var(--warm-gray);
            letter-spacing: 1px;
            border-top: 1px solid rgba(26,20,16,0.04);
        }

        /* Responsive */
        @media (max-width: 380px) {
            .expression { font-size: 22px; }
            .btn-family { font-size: 16px; padding: 12px 4px; }
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="header">
            <h1>è¦ªå±¬ç¨±è¬‚è¨ˆç®—æ©Ÿ</h1>
            <p>Family Relationship Calculator â€” Taiwan</p>
            <button class="sound-toggle" id="soundToggle" onclick="toggleSound()" title="Toggle pronunciation">
                <span class="icon-on">ğŸ”Š</span>
                <span class="icon-off">ğŸ”‡</span>
                <span class="speaking-indicator" id="speakingDot"></span>
            </button>
        </div>

        <div class="display-area">
            <div class="expression" id="expression">
                <span class="placeholder">æˆ‘çš„â‹¯</span>
            </div>
            <div class="result-area" id="resultArea">
                <span class="label">æŒ‰ä¸‹ã€Œæ˜¯ã€ä¾†æŸ¥è©¢ç¨±è¬‚</span>
            </div>
        </div>

        <div class="buttons">
            <div class="section-label">å®¶äºº Family</div>
            <div class="btn-row family">
                <button class="btn-family" onclick="addRelation('çˆ¸çˆ¸')">çˆ¸çˆ¸<span class="en">dad</span></button>
                <button class="btn-family" onclick="addRelation('åª½åª½')">åª½åª½<span class="en">mom</span></button>
                <button class="btn-family" onclick="addRelation('å“¥å“¥')">å“¥å“¥<span class="en">older bro</span></button>
                <button class="btn-family" onclick="addRelation('å¼Ÿå¼Ÿ')">å¼Ÿå¼Ÿ<span class="en">younger bro</span></button>
            </div>
            <div class="btn-row family">
                <button class="btn-family" onclick="addRelation('å§Šå§Š')">å§Šå§Š<span class="en">older sis</span></button>
                <button class="btn-family" onclick="addRelation('å¦¹å¦¹')">å¦¹å¦¹<span class="en">younger sis</span></button>
                <button class="btn-family" onclick="addRelation('å…’å­')">å…’å­<span class="en">son</span></button>
                <button class="btn-family" onclick="addRelation('å¥³å…’')">å¥³å…’<span class="en">daughter</span></button>
            </div>

            <div class="section-label" style="margin-top: 4px;">é…å¶ Spouse</div>
            <div class="btn-row family">
                <button class="btn-family" onclick="addRelation('ä¸ˆå¤«')">ä¸ˆå¤«<span class="en">husband</span></button>
                <button class="btn-family" onclick="addRelation('å¤ªå¤ª')">å¤ªå¤ª<span class="en">wife</span></button>
                <button class="btn-family" style="visibility:hidden"></button>
                <button class="btn-family" style="visibility:hidden"></button>
            </div>

            <div class="section-label" style="margin-top: 4px;">æ“ä½œ Controls</div>
            <div class="btn-row controls">
                <button class="btn-de" onclick="addDe()">çš„</button>
                <button class="btn-equals" onclick="calculate()">æ˜¯</button>
                <button class="btn-back" onclick="backspace()">â†</button>
                <button class="btn-clear" onclick="clearAll()">æ¸…é™¤</button>
            </div>
        </div>

        <div class="footer">è‡ºç£å‚³çµ±è¦ªå±¬ç¨±è¬‚ Â· Traditional Chinese Kinship</div>
    </div>

    <script>
    // State
    let chain = []; // array of relation strings like ['çˆ¸çˆ¸', 'çˆ¸çˆ¸']
    let hasDe = false; // whether the last token was çš„
    let soundOn = false; // sound toggle state â€” off by default (needs user gesture)
    document.getElementById('soundToggle').classList.add('off');

    // ============================
    // TEXT-TO-SPEECH (cross-platform)
    // Single persistent Audio element to prevent overlap.
    // Uses Google Translate TTS, falls back to Web Speech API.
    // ============================
    const audioEl = new Audio();
    audioEl.volume = 1.0;
    let speakId = 0; // monotonic ID to ignore stale callbacks

    function getTTSUrl(text) {
        const encoded = encodeURIComponent(text);
        return `https://translate.google.com/translate_tts?ie=UTF-8&tl=zh-TW&client=tw-ob&q=${encoded}`;
    }

    function hardStop() {
        speakId++;
        audioEl.pause();
        audioEl.removeAttribute('src');
        audioEl.load(); // reset internal state fully
        audioEl.onended = null;
        audioEl.onerror = null;
        if (typeof speechSynthesis !== 'undefined') {
            try { speechSynthesis.cancel(); } catch(e) {}
        }
        document.getElementById('speakingDot').classList.remove('active');
    }

    function speak(text) {
        if (!soundOn || !text) return Promise.resolve();

        // Kill anything currently playing
        hardStop();

        const myId = speakId;
        const dot = document.getElementById('speakingDot');

        return new Promise((resolve) => {
            dot.classList.add('active');

            const done = () => {
                if (myId !== speakId) return; // stale, ignore
                dot.classList.remove('active');
                audioEl.onended = null;
                audioEl.onerror = null;
                resolve();
            };

            const tryFallback = () => {
                if (myId !== speakId) { resolve(); return; }
                if (typeof speechSynthesis !== 'undefined') {
                    speakFallback(text, myId).then(resolve);
                } else {
                    done();
                }
            };

            try {
                audioEl.onended = done;
                audioEl.onerror = tryFallback;
                audioEl.src = getTTSUrl(text);
                audioEl.load();
                audioEl.playbackRate = 1.4;

                const playPromise = audioEl.play();
                if (playPromise && playPromise.catch) {
                    playPromise.catch(tryFallback);
                }
            } catch(e) {
                tryFallback();
            }
        });
    }

    // Web Speech API fallback for desktop browsers
    function speakFallback(text, myId) {
        return new Promise((resolve) => {
            if (myId !== speakId) { resolve(); return; }
            try {
                speechSynthesis.cancel();
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'zh-TW';
                utter.rate = 1.3;

                const dot = document.getElementById('speakingDot');
                dot.classList.add('active');

                utter.onend = () => {
                    if (myId !== speakId) { resolve(); return; }
                    dot.classList.remove('active');
                    resolve();
                };
                utter.onerror = () => {
                    dot.classList.remove('active');
                    resolve();
                };
                speechSynthesis.speak(utter);
            } catch(e) {
                resolve();
            }
        });
    }

    function toggleSound() {
        soundOn = !soundOn;
        const btn = document.getElementById('soundToggle');
        if (soundOn) {
            btn.classList.remove('off');
        } else {
            btn.classList.add('off');
            hardStop();
        }
    }

    // ============================
    // COMPREHENSIVE RELATIONSHIP MAP
    // Keys are chains joined by 'çš„', values are [title, note, pinyin]
    // ============================
    const RELATIONS = {
        // === SELF's parents ===
        'çˆ¸çˆ¸': ['çˆ¸çˆ¸', 'çˆ¶è¦ª', 'bÃ ba'],
        'åª½åª½': ['åª½åª½', 'æ¯è¦ª', 'mÄma'],

        // === Paternal grandparents ===
        'çˆ¸çˆ¸çš„çˆ¸çˆ¸': ['çˆºçˆº', 'ç¥–çˆ¶', 'yÃ©ye'],
        'çˆ¸çˆ¸çš„åª½åª½': ['å¥¶å¥¶', 'ç¥–æ¯', 'nÇinai'],

        // === Maternal grandparents ===
        'åª½åª½çš„çˆ¸çˆ¸': ['å¤–å…¬', 'å¤–ç¥–çˆ¶', 'wÃ igÅng'],
        'åª½åª½çš„åª½åª½': ['å¤–å©†', 'å¤–ç¥–æ¯', 'wÃ ipÃ³'],

        // === Paternal great-grandparents ===
        'çˆ¸çˆ¸çš„çˆ¸çˆ¸çš„çˆ¸çˆ¸': ['æ›¾ç¥–çˆ¶', 'å¤ªå…¬', 'zÄ“ngzÇ”fÃ¹'],
        'çˆ¸çˆ¸çš„çˆ¸çˆ¸çš„åª½åª½': ['æ›¾ç¥–æ¯', 'å¤ªå©†', 'zÄ“ngzÇ”mÇ”'],
        'çˆ¸çˆ¸çš„åª½åª½çš„çˆ¸çˆ¸': ['å¤–æ›¾ç¥–çˆ¶', '(å¥¶å¥¶çš„çˆ¶è¦ª)', 'wÃ izÄ“ngzÇ”fÃ¹'],
        'çˆ¸çˆ¸çš„åª½åª½çš„åª½åª½': ['å¤–æ›¾ç¥–æ¯', '(å¥¶å¥¶çš„æ¯è¦ª)', 'wÃ izÄ“ngzÇ”mÇ”'],

        // === Maternal great-grandparents ===
        'åª½åª½çš„çˆ¸çˆ¸çš„çˆ¸çˆ¸': ['å¤–æ›¾ç¥–çˆ¶', '(å¤–å…¬çš„çˆ¶è¦ª)', 'wÃ izÄ“ngzÇ”fÃ¹'],
        'åª½åª½çš„çˆ¸çˆ¸çš„åª½åª½': ['å¤–æ›¾ç¥–æ¯', '(å¤–å…¬çš„æ¯è¦ª)', 'wÃ izÄ“ngzÇ”mÇ”'],
        'åª½åª½çš„åª½åª½çš„çˆ¸çˆ¸': ['å¤–æ›¾å¤–ç¥–çˆ¶', '(å¤–å©†çš„çˆ¶è¦ª)', 'wÃ izÄ“ngwÃ izÇ”fÃ¹'],
        'åª½åª½çš„åª½åª½çš„åª½åª½': ['å¤–æ›¾å¤–ç¥–æ¯', '(å¤–å©†çš„æ¯è¦ª)', 'wÃ izÄ“ngwÃ izÇ”mÇ”'],

        // === Father's siblings ===
        'çˆ¸çˆ¸çš„å“¥å“¥': ['ä¼¯çˆ¶', 'ä¼¯ä¼¯', 'bÃ³fÃ¹'],
        'çˆ¸çˆ¸çš„å¼Ÿå¼Ÿ': ['å”å”', 'å”çˆ¶', 'shÅ«shu'],
        'çˆ¸çˆ¸çš„å§Šå§Š': ['å§‘å§‘', 'å§‘åª½', 'gÅ«gu'],
        'çˆ¸çˆ¸çš„å¦¹å¦¹': ['å§‘å§‘', 'å°å§‘', 'gÅ«gu'],

        // === Father's siblings' spouses ===
        'çˆ¸çˆ¸çš„å“¥å“¥çš„å¤ªå¤ª': ['ä¼¯æ¯', 'ä¼¯å¨˜', 'bÃ³mÇ”'],
        'çˆ¸çˆ¸çš„å¼Ÿå¼Ÿçš„å¤ªå¤ª': ['å¬¸å¬¸', 'å¬¸æ¯', 'shÄ›nshen'],
        'çˆ¸çˆ¸çš„å§Šå§Šçš„ä¸ˆå¤«': ['å§‘ä¸ˆ', 'å§‘çˆ¶', 'gÅ«zhÃ ng'],
        'çˆ¸çˆ¸çš„å¦¹å¦¹çš„ä¸ˆå¤«': ['å§‘ä¸ˆ', 'å§‘çˆ¶', 'gÅ«zhÃ ng'],

        // === Mother's siblings ===
        'åª½åª½çš„å“¥å“¥': ['èˆ…èˆ…', 'èˆ…çˆ¶', 'jiÃ¹jiu'],
        'åª½åª½çš„å¼Ÿå¼Ÿ': ['èˆ…èˆ…', 'èˆ…çˆ¶', 'jiÃ¹jiu'],
        'åª½åª½çš„å§Šå§Š': ['å§¨åª½', 'å¤§å§¨', 'yÃ­mÄ'],
        'åª½åª½çš„å¦¹å¦¹': ['é˜¿å§¨', 'å°å§¨', 'ÄyÃ­'],

        // === Mother's siblings' spouses ===
        'åª½åª½çš„å“¥å“¥çš„å¤ªå¤ª': ['èˆ…åª½', 'èˆ…æ¯', 'jiÃ¹mÄ'],
        'åª½åª½çš„å¼Ÿå¼Ÿçš„å¤ªå¤ª': ['èˆ…åª½', 'èˆ…æ¯', 'jiÃ¹mÄ'],
        'åª½åª½çš„å§Šå§Šçš„ä¸ˆå¤«': ['å§¨ä¸ˆ', 'å§¨çˆ¶', 'yÃ­zhÃ ng'],
        'åª½åª½çš„å¦¹å¦¹çš„ä¸ˆå¤«': ['å§¨ä¸ˆ', 'å§¨çˆ¶', 'yÃ­zhÃ ng'],

        // === Siblings ===
        'å“¥å“¥': ['å“¥å“¥', 'å…„', 'gÄ“ge'],
        'å¼Ÿå¼Ÿ': ['å¼Ÿå¼Ÿ', 'å¼Ÿ', 'dÃ¬di'],
        'å§Šå§Š': ['å§Šå§Š', 'å§Š', 'jiÄ›jie'],
        'å¦¹å¦¹': ['å¦¹å¦¹', 'å¦¹', 'mÃ¨imei'],

        // === Siblings' spouses ===
        'å“¥å“¥çš„å¤ªå¤ª': ['å«‚å«‚', 'å«‚å­', 'sÇosao'],
        'å¼Ÿå¼Ÿçš„å¤ªå¤ª': ['å¼Ÿåª³', 'å¼Ÿå¦¹', 'dÃ¬xÃ­'],
        'å§Šå§Šçš„ä¸ˆå¤«': ['å§Šå¤«', 'å§å¤«', 'jiÄ›fÅ«'],
        'å¦¹å¦¹çš„ä¸ˆå¤«': ['å¦¹å¤«', 'å¦¹å©¿', 'mÃ¨ifÅ«'],

        // === Own spouse ===
        'ä¸ˆå¤«': ['ä¸ˆå¤«', 'å…ˆç”Ÿ/è€å…¬', 'zhÃ ngfÅ«'],
        'å¤ªå¤ª': ['å¤ªå¤ª', 'å¦»å­/è€å©†', 'tÃ itai'],

        // === Children ===
        'å…’å­': ['å…’å­', 'å­', 'Ã©rzi'],
        'å¥³å…’': ['å¥³å…’', 'å¥³', 'nÇšÊ¼Ã©r'],

        // === Children's spouses ===
        'å…’å­çš„å¤ªå¤ª': ['åª³å©¦', 'å…’åª³', 'xÃ­fÃ¹'],
        'å¥³å…’çš„ä¸ˆå¤«': ['å¥³å©¿', 'å§‘çˆº', 'nÇšxÃ¹'],

        // === Grandchildren ===
        'å…’å­çš„å…’å­': ['å­«å­', 'å­«å…’', 'sÅ«nzi'],
        'å…’å­çš„å¥³å…’': ['å­«å¥³', '', 'sÅ«nnÇš'],
        'å¥³å…’çš„å…’å­': ['å¤–å­«', 'å¤–å­«å­', 'wÃ isÅ«n'],
        'å¥³å…’çš„å¥³å…’': ['å¤–å­«å¥³', '', 'wÃ isÅ«nnÇš'],

        // === Great-grandchildren ===
        'å…’å­çš„å…’å­çš„å…’å­': ['æ›¾å­«', '', 'zÄ“ngsÅ«n'],
        'å…’å­çš„å…’å­çš„å¥³å…’': ['æ›¾å­«å¥³', '', 'zÄ“ngsÅ«nnÇš'],
        'å¥³å…’çš„å…’å­çš„å…’å­': ['å¤–æ›¾å­«', '', 'wÃ izÄ“ngsÅ«n'],
        'å¥³å…’çš„å¥³å…’çš„å¥³å…’': ['å¤–æ›¾å­«å¥³', '', 'wÃ izÄ“ngsÅ«nnÇš'],

        // === Spouse's parents (in-laws) ===
        'ä¸ˆå¤«çš„çˆ¸çˆ¸': ['å…¬å…¬', 'å®¶ç¿', 'gÅnggong'],
        'ä¸ˆå¤«çš„åª½åª½': ['å©†å©†', 'å®¶å§‘', 'pÃ³po'],
        'å¤ªå¤ªçš„çˆ¸çˆ¸': ['å²³çˆ¶', 'ä¸ˆäºº', 'yuÃ¨fÃ¹'],
        'å¤ªå¤ªçš„åª½åª½': ['å²³æ¯', 'ä¸ˆæ¯å¨˜', 'yuÃ¨mÇ”'],

        // === Spouse's siblings ===
        'ä¸ˆå¤«çš„å“¥å“¥': ['å¤§ä¼¯', 'å¤§ä¼¯å­', 'dÃ bÃ³'],
        'ä¸ˆå¤«çš„å¼Ÿå¼Ÿ': ['å°å”', 'å°å”å­', 'xiÇoshÅ«'],
        'ä¸ˆå¤«çš„å§Šå§Š': ['å¤§å§‘', 'å¤§å§‘å­', 'dÃ gÅ«'],
        'ä¸ˆå¤«çš„å¦¹å¦¹': ['å°å§‘', 'å°å§‘å­', 'xiÇogÅ«'],
        'å¤ªå¤ªçš„å“¥å“¥': ['å¤§èˆ…å­', 'å…§å…„', 'dÃ jiÃ¹zi'],
        'å¤ªå¤ªçš„å¼Ÿå¼Ÿ': ['å°èˆ…å­', 'å…§å¼Ÿ', 'xiÇojiÃ¹zi'],
        'å¤ªå¤ªçš„å§Šå§Š': ['å¤§å§¨å­', 'å§¨å§Š', 'dÃ yÃ­zi'],
        'å¤ªå¤ªçš„å¦¹å¦¹': ['å°å§¨å­', 'å§¨å¦¹', 'xiÇoyÃ­zi'],

        // === Spouse's siblings' spouses ===
        'ä¸ˆå¤«çš„å“¥å“¥çš„å¤ªå¤ª': ['å¤§å«‚', '', 'dÃ sÇo'],
        'ä¸ˆå¤«çš„å¼Ÿå¼Ÿçš„å¤ªå¤ª': ['å¼Ÿåª³', '', 'dÃ¬xÃ­'],
        'ä¸ˆå¤«çš„å§Šå§Šçš„ä¸ˆå¤«': ['å¤§å§‘ä¸ˆ', '', 'dÃ gÅ«zhÃ ng'],
        'ä¸ˆå¤«çš„å¦¹å¦¹çš„ä¸ˆå¤«': ['å°å§‘ä¸ˆ', '', 'xiÇogÅ«zhÃ ng'],

        // === Paternal cousins (father's brothers' children) ===
        'çˆ¸çˆ¸çš„å“¥å“¥çš„å…’å­': ['å ‚å“¥/å ‚å¼Ÿ', 'å ‚å…„å¼Ÿ', 'tÃ¡nggÄ“ / tÃ¡ngdÃ¬'],
        'çˆ¸çˆ¸çš„å“¥å“¥çš„å¥³å…’': ['å ‚å§Š/å ‚å¦¹', 'å ‚å§Šå¦¹', 'tÃ¡ngjiÄ› / tÃ¡ngmÃ¨i'],
        'çˆ¸çˆ¸çš„å¼Ÿå¼Ÿçš„å…’å­': ['å ‚å“¥/å ‚å¼Ÿ', 'å ‚å…„å¼Ÿ', 'tÃ¡nggÄ“ / tÃ¡ngdÃ¬'],
        'çˆ¸çˆ¸çš„å¼Ÿå¼Ÿçš„å¥³å…’': ['å ‚å§Š/å ‚å¦¹', 'å ‚å§Šå¦¹', 'tÃ¡ngjiÄ› / tÃ¡ngmÃ¨i'],

        // === Paternal cousins (father's sisters' children) ===
        'çˆ¸çˆ¸çš„å§Šå§Šçš„å…’å­': ['è¡¨å“¥/è¡¨å¼Ÿ', 'å§‘è¡¨å…„å¼Ÿ', 'biÇogÄ“ / biÇodÃ¬'],
        'çˆ¸çˆ¸çš„å§Šå§Šçš„å¥³å…’': ['è¡¨å§Š/è¡¨å¦¹', 'å§‘è¡¨å§Šå¦¹', 'biÇojiÄ› / biÇomÃ¨i'],
        'çˆ¸çˆ¸çš„å¦¹å¦¹çš„å…’å­': ['è¡¨å“¥/è¡¨å¼Ÿ', 'å§‘è¡¨å…„å¼Ÿ', 'biÇogÄ“ / biÇodÃ¬'],
        'çˆ¸çˆ¸çš„å¦¹å¦¹çš„å¥³å…’': ['è¡¨å§Š/è¡¨å¦¹', 'å§‘è¡¨å§Šå¦¹', 'biÇojiÄ› / biÇomÃ¨i'],

        // === Maternal cousins (mother's brothers' children) ===
        'åª½åª½çš„å“¥å“¥çš„å…’å­': ['è¡¨å“¥/è¡¨å¼Ÿ', 'èˆ…è¡¨å…„å¼Ÿ', 'biÇogÄ“ / biÇodÃ¬'],
        'åª½åª½çš„å“¥å“¥çš„å¥³å…’': ['è¡¨å§Š/è¡¨å¦¹', 'èˆ…è¡¨å§Šå¦¹', 'biÇojiÄ› / biÇomÃ¨i'],
        'åª½åª½çš„å¼Ÿå¼Ÿçš„å…’å­': ['è¡¨å“¥/è¡¨å¼Ÿ', 'èˆ…è¡¨å…„å¼Ÿ', 'biÇogÄ“ / biÇodÃ¬'],
        'åª½åª½çš„å¼Ÿå¼Ÿçš„å¥³å…’': ['è¡¨å§Š/è¡¨å¦¹', 'èˆ…è¡¨å§Šå¦¹', 'biÇojiÄ› / biÇomÃ¨i'],

        // === Maternal cousins (mother's sisters' children) ===
        'åª½åª½çš„å§Šå§Šçš„å…’å­': ['è¡¨å“¥/è¡¨å¼Ÿ', 'å§¨è¡¨å…„å¼Ÿ', 'biÇogÄ“ / biÇodÃ¬'],
        'åª½åª½çš„å§Šå§Šçš„å¥³å…’': ['è¡¨å§Š/è¡¨å¦¹', 'å§¨è¡¨å§Šå¦¹', 'biÇojiÄ› / biÇomÃ¨i'],
        'åª½åª½çš„å¦¹å¦¹çš„å…’å­': ['è¡¨å“¥/è¡¨å¼Ÿ', 'å§¨è¡¨å…„å¼Ÿ', 'biÇogÄ“ / biÇodÃ¬'],
        'åª½åª½çš„å¦¹å¦¹çš„å¥³å…’': ['è¡¨å§Š/è¡¨å¦¹', 'å§¨è¡¨å§Šå¦¹', 'biÇojiÄ› / biÇomÃ¨i'],

        // === Nephews & Nieces (brother's children) ===
        'å“¥å“¥çš„å…’å­': ['å§ªå­', 'å§ªå…’', 'zhÃ­zi'],
        'å“¥å“¥çš„å¥³å…’': ['å§ªå¥³', '', 'zhÃ­nÇš'],
        'å¼Ÿå¼Ÿçš„å…’å­': ['å§ªå­', 'å§ªå…’', 'zhÃ­zi'],
        'å¼Ÿå¼Ÿçš„å¥³å…’': ['å§ªå¥³', '', 'zhÃ­nÇš'],

        // === Nephews & Nieces (sister's children) ===
        'å§Šå§Šçš„å…’å­': ['å¤–ç”¥', '', 'wÃ ishÄ“ng'],
        'å§Šå§Šçš„å¥³å…’': ['å¤–ç”¥å¥³', '', 'wÃ ishÄ“ngnÇš'],
        'å¦¹å¦¹çš„å…’å­': ['å¤–ç”¥', '', 'wÃ ishÄ“ng'],
        'å¦¹å¦¹çš„å¥³å…’': ['å¤–ç”¥å¥³', '', 'wÃ ishÄ“ngnÇš'],

        // === Paternal grandparents' siblings ===
        'çˆ¸çˆ¸çš„çˆ¸çˆ¸çš„å“¥å“¥': ['ä¼¯å…¬', 'ä¼¯ç¥–çˆ¶', 'bÃ³gÅng'],
        'çˆ¸çˆ¸çš„çˆ¸çˆ¸çš„å¼Ÿå¼Ÿ': ['å”å…¬', 'å”ç¥–çˆ¶', 'shÅ«gÅng'],
        'çˆ¸çˆ¸çš„çˆ¸çˆ¸çš„å§Šå§Š': ['å§‘å©†', 'å§‘ç¥–æ¯', 'gÅ«pÃ³'],
        'çˆ¸çˆ¸çš„çˆ¸çˆ¸çš„å¦¹å¦¹': ['å§‘å©†', 'å§‘ç¥–æ¯', 'gÅ«pÃ³'],
        'çˆ¸çˆ¸çš„åª½åª½çš„å“¥å“¥': ['èˆ…å…¬', 'èˆ…ç¥–çˆ¶', 'jiÃ¹gÅng'],
        'çˆ¸çˆ¸çš„åª½åª½çš„å¼Ÿå¼Ÿ': ['èˆ…å…¬', 'èˆ…ç¥–çˆ¶', 'jiÃ¹gÅng'],
        'çˆ¸çˆ¸çš„åª½åª½çš„å§Šå§Š': ['å§¨å©†', 'å§¨ç¥–æ¯', 'yÃ­pÃ³'],
        'çˆ¸çˆ¸çš„åª½åª½çš„å¦¹å¦¹': ['å§¨å©†', 'å§¨ç¥–æ¯', 'yÃ­pÃ³'],

        // === Maternal grandparents' siblings ===
        'åª½åª½çš„çˆ¸çˆ¸çš„å“¥å“¥': ['å¤–ä¼¯å…¬', '', 'wÃ ibÃ³gÅng'],
        'åª½åª½çš„çˆ¸çˆ¸çš„å¼Ÿå¼Ÿ': ['å¤–å”å…¬', '', 'wÃ ishÅ«gÅng'],
        'åª½åª½çš„çˆ¸çˆ¸çš„å§Šå§Š': ['å¤–å§‘å©†', '', 'wÃ igÅ«pÃ³'],
        'åª½åª½çš„çˆ¸çˆ¸çš„å¦¹å¦¹': ['å¤–å§‘å©†', '', 'wÃ igÅ«pÃ³'],
        'åª½åª½çš„åª½åª½çš„å“¥å“¥': ['å¤–èˆ…å…¬', '', 'wÃ ijiÃ¹gÅng'],
        'åª½åª½çš„åª½åª½çš„å¼Ÿå¼Ÿ': ['å¤–èˆ…å…¬', '', 'wÃ ijiÃ¹gÅng'],
        'åª½åª½çš„åª½åª½çš„å§Šå§Š': ['å¤–å§¨å©†', '', 'wÃ iyÃ­pÃ³'],
        'åª½åª½çš„åª½åª½çš„å¦¹å¦¹': ['å¤–å§¨å©†', '', 'wÃ iyÃ­pÃ³'],

        // === Spouse's grandparents ===
        'ä¸ˆå¤«çš„çˆ¸çˆ¸çš„çˆ¸çˆ¸': ['çˆºçˆº', '(ä¸ˆå¤«çš„ç¥–çˆ¶)', 'yÃ©ye'],
        'ä¸ˆå¤«çš„çˆ¸çˆ¸çš„åª½åª½': ['å¥¶å¥¶', '(ä¸ˆå¤«çš„ç¥–æ¯)', 'nÇinai'],
        'ä¸ˆå¤«çš„åª½åª½çš„çˆ¸çˆ¸': ['å¤–å…¬', '(ä¸ˆå¤«çš„å¤–ç¥–çˆ¶)', 'wÃ igÅng'],
        'ä¸ˆå¤«çš„åª½åª½çš„åª½åª½': ['å¤–å©†', '(ä¸ˆå¤«çš„å¤–ç¥–æ¯)', 'wÃ ipÃ³'],
        'å¤ªå¤ªçš„çˆ¸çˆ¸çš„çˆ¸çˆ¸': ['å²³ç¥–çˆ¶', '(å¤ªå¤ªçš„ç¥–çˆ¶)', 'yuÃ¨zÇ”fÃ¹'],
        'å¤ªå¤ªçš„çˆ¸çˆ¸çš„åª½åª½': ['å²³ç¥–æ¯', '(å¤ªå¤ªçš„ç¥–æ¯)', 'yuÃ¨zÇ”mÇ”'],

        // === Nephews/Nieces' children ===
        'å“¥å“¥çš„å…’å­çš„å…’å­': ['å§ªå­«', '', 'zhÃ­sÅ«n'],
        'å“¥å“¥çš„å…’å­çš„å¥³å…’': ['å§ªå­«å¥³', '', 'zhÃ­sÅ«nnÇš'],
        'å§Šå§Šçš„å…’å­çš„å…’å­': ['å¤–ç”¥å­«', '', 'wÃ ishÄ“ngsÅ«n'],
        'å§Šå§Šçš„å…’å­çš„å¥³å…’': ['å¤–ç”¥å­«å¥³', '', 'wÃ ishÄ“ngsÅ«nnÇš'],

        // === Uncle/Aunt's grandchildren perspectives ===
        'çˆ¸çˆ¸çš„å“¥å“¥çš„å…’å­çš„å…’å­': ['å ‚å§ª', '', 'tÃ¡ngzhÃ­'],
        'çˆ¸çˆ¸çš„å“¥å“¥çš„å…’å­çš„å¥³å…’': ['å ‚å§ªå¥³', '', 'tÃ¡ngzhÃ­nÇš'],
        'çˆ¸çˆ¸çš„å§Šå§Šçš„å…’å­çš„å…’å­': ['è¡¨å§ª', '', 'biÇozhÃ­'],
        'åª½åª½çš„å“¥å“¥çš„å…’å­çš„å…’å­': ['è¡¨å§ª', '', 'biÇozhÃ­'],
    };

    // ============================
    // UI Logic
    // ============================

    function updateDisplay() {
        const expr = document.getElementById('expression');

        if (chain.length === 0 && !hasDe) {
            expr.innerHTML = '<span class="placeholder">æˆ‘çš„â‹¯</span>';
            return;
        }

        let html = 'æˆ‘';
        chain.forEach((rel, i) => {
            html += '<span class="de">çš„</span>' + rel;
        });
        if (hasDe) {
            html += '<span class="de">çš„</span>â‹¯';
        }

        expr.innerHTML = html;
    }

    function addRelation(rel) {
        // Only add a relation if we're at the start or after çš„
        if (chain.length === 0 || hasDe) {
            chain.push(rel);
            hasDe = false;
            updateDisplay();
            clearResult();
            speak(rel);
        }
    }

    function addDe() {
        if (chain.length > 0 && !hasDe) {
            hasDe = true;
            updateDisplay();
            speak('çš„');
        }
    }

    function backspace() {
        if (hasDe) {
            hasDe = false;
        } else if (chain.length > 0) {
            chain.pop();
        }
        updateDisplay();
        clearResult();
    }

    function clearAll() {
        chain = [];
        hasDe = false;
        updateDisplay();
        clearResult();
        hardStop();
    }

    function clearResult() {
        document.getElementById('resultArea').innerHTML =
            '<span class="label">æŒ‰ä¸‹ã€Œæ˜¯ã€ä¾†æŸ¥è©¢ç¨±è¬‚</span>';
    }

    function calculate() {
        if (chain.length === 0) return;

        const key = chain.join('çš„');
        const result = RELATIONS[key];
        const area = document.getElementById('resultArea');

        if (result) {
            const [title, note, pinyin] = result;
            let html = '<div>';
            html += `<div class="result">${title}</div>`;
            if (pinyin) {
                html += `<div class="result-pinyin">${pinyin}</div>`;
            }
            if (note) {
                html += `<div class="result-note">${note}</div>`;
            }
            html += '</div>';
            area.innerHTML = html;

            // Speak "æ˜¯" then the result title
            speak('æ˜¯').then(() => {
                setTimeout(() => speak(title), 150);
            });
        } else {
            area.innerHTML = `<span class="error">æ‰¾ä¸åˆ°æ­¤ç¨±è¬‚ â€” çµ„åˆå¯èƒ½å¤ªæ·±æˆ–ä¸å¸¸è¦‹</span>`;
            speak('æ˜¯').then(() => {
                setTimeout(() => speak('æ‰¾ä¸åˆ°æ­¤ç¨±è¬‚'), 150);
            });
        }
    }

    // Initialize
    updateDisplay();
    </script>
</body>
</html>
